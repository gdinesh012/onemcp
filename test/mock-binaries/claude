#!/bin/bash

# Mock Claude CLI for testing
# Parses arguments and returns mock JSON response

query=""
model="haiku"

while [[ $# -gt 0 ]]; do
  case $1 in
    --model)
      model="$2"
      shift 2
      ;;
    --print|--output-format|--tools)
      shift
      if [[ "$1" != --* ]]; then
        shift
      fi
      ;;
    --dangerously-skip-permissions)
      shift
      ;;
    --)
      # End of options, everything after is the prompt
      shift
      query="$*"
      break
      ;;
    *)
      # Assume it's the prompt/query
      query="$1"
      shift
      ;;
  esac
done

# Extract the actual user query from the prompt
# The prompt format is: Given this query: "USER_QUERY"
user_query=$(echo "$query" | sed -n 's/.*Given this query: "\([^"]*\)".*/\1/p')

# If we couldn't extract the user query, use the full query
if [ -z "$user_query" ]; then
  user_query="$query"
fi

# Extract tool names based on user query
# Mock response with tools that match the integration test mock servers
if [[ "$user_query" == *"screenshot"* ]] || [[ "$user_query" == *"image"* ]] || [[ "$user_query" == *"capture"* ]]; then
  tools='["browser_screenshot"]'
elif [[ "$user_query" == *"navigate"* ]] || [[ "$user_query" == *"webpage"* ]]; then
  tools='["browser_navigate"]'
elif [[ "$user_query" == *"click"* ]] || [[ "$user_query" == *"element"* ]]; then
  tools='["browser_click"]'
elif [[ "$user_query" == *"read"* ]] && [[ "$user_query" == *"file"* ]]; then
  tools='["filesystem_read_file"]'
elif [[ "$user_query" == *"write"* ]] && [[ "$user_query" == *"file"* ]]; then
  tools='["filesystem_write_file"]'
elif [[ "$user_query" == *"directory"* ]] || [[ "$user_query" == *"list"* ]]; then
  tools='["filesystem_list_directory"]'
else
  # Default: return tools from mock servers
  tools='["browser_navigate", "browser_screenshot", "browser_click", "filesystem_read_file", "filesystem_write_file"]'
fi

# Return mock response in Claude CLI format
# Escape the tools JSON for embedding in the result string
tools_escaped=$(echo "$tools" | sed 's/"/\\"/g')

cat <<EOF
{
  "type": "result",
  "result": "$tools_escaped",
  "model": "$model",
  "stop_reason": "end_turn",
  "usage": {
    "input_tokens": 100,
    "output_tokens": 50
  }
}
EOF
